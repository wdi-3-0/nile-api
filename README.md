# Nile API
This is the back-end for Nile, an e-commerce site with secure payments via
Stripe. Nile sells one-of-a-kind art made by various talented digital artists.

We safely handle customers' credit card information through Stripe's Checkout.
Checkout creates a related token, that we use to make a charge request through Stripe.

See the front end in action [here](https://wdi-3-0.github.io/nile-client/)

See the front end repo [here](https://github.com/wdi-3-0/nile-client)

Unfortunately, we're not able to accept payments, or make deliveries at this point.
Please use a test credit card 4242 4242 4242 4242, and an expiration date some
date in the future to simulate buying something.

### Technologies used
1. Express.js
2. Node.js
3. Stripe (Checkout)
4. Passport
5. Grunt
6. Body-parser

### Future issues
1. We currently store the token generated by Stripe Checkout in our Mongodb, but this step could be eliminated.
2. We would like to add virtuals to products, and cart schemas to directly calculate checkout totals in the back end rather than calculating in the front end.

### Planning

#### ERD

![Entity Relationship Diagram](https://i.imgur.com/fQcOcT1.png)

We wrote the routes according to our understanding of how a user would navigate the site.
A user would sign in, add items to the cart, check out and make payments via Stripe, then review their purchase history. For all of this flow to work, the user would need to have only one active cart.

Purchases are associated with users (a user has many purchases), and includes the
items array, and a closed status. Closed purchases are categorized as purchases, and only allow get actions. Users can see their closed purchase history, but they won't be able to modify them in any way. Open purchases are categorized as cart - users can modify these carts to add and remove items.

Our biggest challenge was connecting Stripe payment API to our back-end, since the documentation assumed that Stripe would be used in apps that integrate the front and back end in the same file. We did a lot of searching through prior years' cohorts repositories, and Stripe's API documentation.

We added an event handler in the front end to trigger Stripe's Checkout (which creates a stripe token) when the user clicks check out. The event handler then makes an ajax request to our /charge route (in the stripe_routes.js file). Charge is tied to a stripe object, which includes a create charge method.

The next challenge was making sure that a user will have only one active cart at any time.
Fortunately, express was flexible enough to customize according to our needs. We tweaked the get carts route to also create an empty, active cart if a user has no cart. We also wrote checkout to change the cart's status to closed, and create a new active, empty cart.

#### Routes

<table style="width:100%">
  <tr>
    <th>Route</th>
    <th>Verbe</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>/cart</td>
    <td>GET</td>
    <td>Find a cart associated with the current user. Create one if it doesn't exist.</td>
  </tr>
  <tr>
    <td>/cart</td>
    <td>POST</td>
    <td>Create an active cart with an empty items array</td>
  </tr>
  <tr>
    <td>/add-item/:id</td>
    <td>PATCH</td>
    <td>Push items into a cart's items array</td>
  </tr>
  <tr>
    <td>/remove-item/:id</td>
    <td>DELETE</td>
    <td>Remove item from cart</td>
  </tr>
  <tr>
    <td>/checkout</td>
    <td>PATCH</td>
    <td>Update a cart's status to inactive. Create a new active cart for the user</td>
  </tr>
  <tr>
    <td>/products</td>
    <td>GET</td>
    <td>Get information for all products</td>
  </tr>
  <tr>
    <td>/purchases</td>
    <td>GET</td>
    <td>Get information from past orders (closed carts)</td>
  </tr>
  <tr>
    <td>/charge</td>
    <td>POST</td>
    <td>Receive token from Stripe checkout and create a stripe charge</td>
  </tr>
  <tr>
    <td>/sign-up</td>
    <td>POST</td>
    <td>Create a user</td>
  </tr>
  <tr>
    <td>/sign-in</td>
    <td>POST</td>
    <td>Sign in a user</td>
  </tr>
  <tr>
    <td>/change-password</td>
    <td>PATCH</td>
    <td>Change user's password</td>
  </tr>
  <tr>
    <td>/sign-out</td>
    <td>DELETE</td>
    <td>Sign user out</td>
  </tr>
</table>
